<html>
  <head>
    <meta charset="utf-8">
    <title>Open-Meteo BA – Últimos 6 meses</title>
    <script src="https://connectors.tableau.com/libs/tableauwdc-2.3.latest.js"></script>
    <script>
      (function () {
        var myConnector = tableau.makeConnector();

        // ---------- Esquema ----------
        myConnector.getSchema = function (schemaCallback) {
          var cols = [
            { id: "time", dataType: tableau.dataTypeEnum.string },
            { id: "temperature_2m", dataType: tableau.dataTypeEnum.float },
            { id: "precipitation", dataType: tableau.dataTypeEnum.float },
            { id: "windspeed_10m", dataType: tableau.dataTypeEnum.float },
            { id: "winddirection_10m", dataType: tableau.dataTypeEnum.float },
            { id: "pressure_msl", dataType: tableau.dataTypeEnum.float }
          ];

          var tableSchema = {
            id: "openMeteoTable",
            alias: "Open-Meteo BA – Últimos 6 meses (horario)",
            columns: cols
          };

          schemaCallback([tableSchema]);
        };

        // ---------- Descarga de datos ----------
        myConnector.getData = function (table, doneCallback) {
          var url = tableau.connectionData;
          if (!url) {
            tableau.abortWithError("No se encontró la URL del API.");
            return;
          }

          fetch(url)
            .then(function (response) {
              if (!response.ok) throw new Error("HTTP " + response.status);
              return response.json();
            })
            .then(function (data) {
              if (!data.hourly || !data.hourly.time) {
                throw new Error("Respuesta sin sección 'hourly'.");
              }

              var h = data.hourly;
              var len = h.time.length;
              var tableData = [];

              for (var i = 0; i < len; i++) {
                tableData.push({
                  time: h.time[i],
                  temperature_2m: h.temperature_2m ? h.temperature_2m[i] : null,
                  precipitation: h.precipitation ? h.precipitation[i] : null,
                  windspeed_10m: h.windspeed_10m ? h.windspeed_10m[i] : null,
                  winddirection_10m: h.winddirection_10m ? h.winddirection_10m[i] : null,
                  pressure_msl: h.pressure_msl ? h.pressure_msl[i] : null
                });
              }

              table.appendRows(tableData);
              doneCallback();
            })
            .catch(function (err) {
              tableau.abortWithError("Error Open-Meteo: " + err.message);
            });
        };

        tableau.registerConnector(myConnector);

        // ---------- Helpers ----------
        function formatDate(d) {
          var y = d.getFullYear();
          var m = String(d.getMonth() + 1).padStart(2, "0");
          var day = String(d.getDate()).padStart(2, "0");
          return y + "-" + m + "-" + day;
        }

        function buildUrlLast6Months() {
          // Siempre Buenos Aires
          var lat = -34.61;
          var lon = -58.38;

          var today = new Date();
          var start = new Date();
          start.setMonth(start.getMonth() - 6);

          var startStr = formatDate(start);
          var endStr = formatDate(today);

          var base = "https://archive-api.open-meteo.com/v1/archive?";
          var params = [
            "latitude=" + lat,
            "longitude=" + lon,
            "start_date=" + startStr,
            "end_date=" + endStr,
            "hourly=temperature_2m,precipitation,windspeed_10m,winddirection_10m,pressure_msl",
            "timezone=America%2FArgentina%2FBuenos_Aires"
          ];

          return {
            url: base + params.join("&"),
            start: startStr,
            end: endStr
          };
        }

        document.addEventListener("DOMContentLoaded", function () {
          var infoSpan = document.getElementById("info");
          var urlSpan = document.getElementById("urlPreview");https://github.com/kindmartin/OpenMeteo/blob/main/openmeteo_wdc.html

          // Precalcular rango y URL
          var cfg = buildUrlLast6Months();
          infoSpan.textContent = cfg.start + "  →  " + cfg.end;
          urlSpan.textContent = cfg.url;

          document.getElementById("submitButton").onclick = function () {
            tableau.connectionName = "BA – Clima Open-Meteo (últimos 6 meses)";
            tableau.connectionData = cfg.url;
            tableau.submit();
          };
        });
      })();
    </script>
    <style>
      body { font-family: Arial, sans-serif; margin: 16px; }
      #urlPreview { font-size: 11px; word-break: break-all; }
      button { margin-top: 12px; padding: 6px 12px; }
    </style>
  </head>

  <body>
    <h2>Open-Meteo – Buenos Aires (últimos 6 meses)</h2>
    <p>
      Ciudad fija: <strong>Buenos Aires (-34.61, -58.38)</strong><br>
      Rango: <span id="info"></span> (calculado al momento de la conexión)
    </p>
    <p><strong>URL generada:</strong><br>
      <span id="urlPreview"></span>
    </p>
    <button id="submitButton">Cargar en Tableau</button>
  </body>
</html>
